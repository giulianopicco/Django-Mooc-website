(function(b){b.fn.formset=function(G){var a=b.extend({},b.fn.formset.defaults,G),u=a.extraClasses.join(" "),C=b("#id_"+a.prefix+"-TOTAL_FORMS"),x=b("#id_"+a.prefix+"-MAX_NUM_FORMS"),D="input,select,textarea,label,div",t=b(this),H=function(c,d){if(a.extraClasses){c.removeClass(u);c.addClass(a.extraClasses[d%a.extraClasses.length])}},s=function(d,c,f){var g=new RegExp(c+"-(\\d+|__prefix__)-"),e=c+"-"+f+"-";if(d.attr("for")){d.attr("for",d.attr("for").replace(g,e))}if(d.attr("id")){d.attr("id",d.attr("id").replace(g,e))}if(d.attr("name")){d.attr("name",d.attr("name").replace(g,e))}},A=function(c){return c.find(D).length>0},w=function(){return x.length==0||(x.val()==""||x.val()-C.val()>0)},B=function(c){if(c.is("TR")){c.children(":last").append('<a class="'+a.deleteCssClass+'" href="javascript:void(0)">'+a.deleteText+"</a>")}else{if(c.is("UL")||c.is("OL")){c.append('<li><a class="'+a.deleteCssClass+'" href="javascript:void(0)">'+a.deleteText+"</a></li>")}else{c.append('<a class="'+a.deleteCssClass+'" href="javascript:void(0)">'+a.deleteText+"</a>")}}c.find("a."+a.deleteCssClass).click(function(){var i=b(this).parents("."+a.formCssClass),h=i.find('input:hidden[id $= "-DELETE"]'),d=i.siblings("a."+a.addCssClass+", ."+a.formCssClass+"-add"),g;if(h.length){h.val("on");i.hide();g=b("."+a.formCssClass).not(":hidden")}else{i.remove();g=b("."+a.formCssClass).not(".formset-custom-template");C.val(g.length)}for(var f=0,e=g.length;f<e;f++){H(g.eq(f),f);if(!h.length){g.eq(f).find(D).each(function(){s(b(this),a.prefix,f)})}}if(d.is(":hidden")&&w()){d.show()}if(a.removed){a.removed(i)}return false})};t.each(function(d){var c=b(this),e=c.find('input:checkbox[id $= "-DELETE"]');if(e.length){if(e.is(":checked")){e.before('<input type="hidden" name="'+e.attr("name")+'" id="'+e.attr("id")+'" value="on" />');c.hide()}else{e.before('<input type="hidden" name="'+e.attr("name")+'" id="'+e.attr("id")+'" />')}b('label[for="'+e.attr("id")+'"]').hide();e.remove()}if(A(c)){c.addClass(a.formCssClass);if(c.is(":visible")){B(c);H(c,d)}}});if(t.length){var F=!w(),y,v;if(a.formTemplate){v=a.formTemplate instanceof b?a.formTemplate:b(a.formTemplate);v.removeAttr("id").addClass(a.formCssClass+" formset-custom-template");v.find(D).each(function(){s(b(this),a.prefix,"__prefix__")});B(v)}else{v=b("."+a.formCssClass+":last").clone(true).removeAttr("id");v.find('input:hidden[id $= "-DELETE"]').remove();v.find(D).not(a.keepFieldValues).each(function(){var c=b(this);if(c.is("input:checkbox")||c.is("input:radio")){c.attr("checked",false)}else{c.val("")}})}a.formTemplate=v;if(t.attr("tagName")=="TR"){var E=t.eq(0).children().length,z=b('<tr><td colspan="'+E+'"><a class="'+a.addCssClass+'" href="javascript:void(0)">'+a.addText+"</a></tr>").addClass(a.formCssClass+"-add");t.parent().append(z);if(F){z.hide()}y=z.find("a")}else{t.filter(":last").after('<a class="'+a.addCssClass+'" href="javascript:void(0)">'+a.addText+"</a>");y=t.filter(":last").next();if(F){y.hide()}}y.click(function(){var d=parseInt(C.val()),c=a.formTemplate.clone(true).removeClass("formset-custom-template"),e=b(b(this).parents("tr."+a.formCssClass+"-add").get(0)||this);H(c,d);c.insertBefore(e).show();c.find(D).each(function(){s(b(this),a.prefix,d)});C.val(d+1);if(!w()){e.hide()}if(a.added){a.added(c)}return false})}return t};b.fn.formset.defaults={prefix:"form",formTemplate:null,addText:"add another",deleteText:"remove",addCssClass:"add-row",deleteCssClass:"delete-row",formCssClass:"dynamic-form",extraClasses:[],keepFieldValues:"",added:null,removed:null}})(jQuery);